[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mSingleUse[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/cards/base/types'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[0m
[38;2;248;248;242m        [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mDiscardSlotComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mHandSlotComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mPlayerComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mSlotComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m} [38;2;255;255;255mfrom[38;2;248;248;242m [38;2;230;219;116m'common/components'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mAIComponent[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/components/ai-component'[0m
[38;2;249;38;114mimport[38;2;248;248;242m [38;2;255;255;255mquery[38;2;248;248;242m [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/components/query'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mPlayerEntity[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/entities'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mGameModel[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/models/game-model'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mserverMessages[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/socket-messages/server-messages'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mTypeT[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/types/cards'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mTurnAction[38;2;248;248;242m, [38;2;255;255;255mTurnActions[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/types/game-state'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[0m
[38;2;248;248;242m        [38;2;255;255;255mAttackActionData[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mPickSlotActionData[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mattackToAttackAction[38;2;248;248;242m,[0m
[38;2;248;248;242m} [38;2;255;255;255mfrom[38;2;248;248;242m [38;2;230;219;116m'common/types/turn-action-data'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mhasEnoughEnergy[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'common/utils/attacks'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mbuffers[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'redux-saga'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mactionChannel[38;2;248;248;242m, [38;2;255;255;255mcall[38;2;248;248;242m, [38;2;255;255;255mdelay[38;2;248;248;242m, [38;2;255;255;255mfork[38;2;248;248;242m, [38;2;255;255;255mrace[38;2;248;248;242m, [38;2;255;255;255mtake[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'typed-redux-saga'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mprintBoardState[38;2;248;248;242m, [38;2;255;255;255mprintHooksState[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'../utils'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mbroadcast[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'../utils/comm'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mgetLocalGameState[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'../utils/state-gen'[0m

[38;2;249;38;114mimport[38;2;248;248;242m [38;2;255;255;255massert[38;2;248;248;242m [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'assert'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mLocalMessage[38;2;248;248;242m, [38;2;255;255;255mLocalMessageTable[38;2;248;248;242m, [38;2;255;255;255mlocalMessages[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'../messages'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[0m
[38;2;248;248;242m        [38;2;255;255;255mapplyEffectSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mattackSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mchangeActiveHermitSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mdelaySaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mmodalRequestSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mpickRequestSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mplayCardSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;255;255;255mremoveEffectSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m} [38;2;255;255;255mfrom[38;2;248;248;242m [38;2;230;219;116m'./turn-actions'[0m
[38;2;249;38;114mimport[38;2;248;248;242m {[38;2;255;255;255mvirtualPlayerActionSaga[38;2;248;248;242m} [38;2;249;38;114mfrom[38;2;248;248;242m [38;2;230;219;116m'./virtual'[0m

[38;2;117;113;94m////////////////////////////////////////[0m
[38;2;117;113;94m// @TODO sort this whole thing out properly[0m
[38;2;117;113;94m/////////////////////////////////////////[0m

[38;2;249;38;114mexport[38;2;248;248;242m [38;2;102;217;239mconst[38;2;248;248;242m [38;2;166;226;46mgetTimerForSeconds[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m        [38;2;166;226;46mgame[38;2;248;248;242m: [38;2;255;255;255mGameModel[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;166;226;46mseconds[38;2;248;248;242m: [38;2;255;255;255mnumber[38;2;248;248;242m,[0m
[38;2;248;248;242m)[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mnumber[38;2;248;248;242m [38;2;102;217;239m=>[38;2;248;248;242m {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mmaxTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mmaxTurnTime[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;190;132;255m1000[0m
[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[38;2;248;248;242m [38;2;249;38;114m-[38;2;248;248;242m [38;2;255;255;255mmaxTime[38;2;248;248;242m [38;2;249;38;114m+[38;2;248;248;242m [38;2;255;255;255mseconds[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;190;132;255m1000[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;248;248;242m [38;2;166;226;46mgetAvailableEnergy[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m {[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m} [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255menergy[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components[0m
[38;2;248;248;242m                .[38;2;166;226;46mfilter[38;2;255;255;255m([0m
[38;2;248;248;242m                        [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255misItem[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mattached[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mrowEntity[38;2;255;255;255m(currentPlayer[38;2;248;248;242m.[38;2;255;255;255mactiveRowEntity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;166;226;46mplayer[38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity))[38;2;248;248;242m,[0m
[38;2;248;248;242m                )[0m
[38;2;248;248;242m                .[38;2;166;226;46mflatMap[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mcard[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m![38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46misItem[38;2;255;255;255m())[38;2;248;248;242m [38;2;249;38;114mreturn[38;2;248;248;242m [][0m
[38;2;248;248;242m                        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255menergy[0m
[38;2;248;248;242m                })[0m

[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mhooks[38;2;248;248;242m.[38;2;255;255;255mavailableEnergy[38;2;248;248;242m.[38;2;102;217;239mcall[38;2;255;255;255m(energy)[0m
[38;2;248;248;242m}[0m

[38;2;117;113;94m/**Returns if an action is currently available for the player to execute.[0m
[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;255;255;255mTo[38;2;248;248;242m [38;2;255;255;255mbe[38;2;248;248;242m [38;2;255;255;255mavailable[38;2;248;248;242m, [38;2;255;255;255man[38;2;248;248;242m [38;2;255;255;255maction[38;2;248;248;242m [38;2;255;255;255mmust[38;2;248;248;242m [38;2;255;255;255mbe[38;2;248;248;242m [38;2;249;38;114min[38;2;248;248;242m [38;2;230;219;116m`state.turn.availableActions`[38;2;248;248;242m, [38;2;255;255;255mand[38;2;248;248;242m [38;2;255;255;255mnot[38;2;248;248;242m [38;2;249;38;114min[38;2;248;248;242m [38;2;230;219;116m`state.turn.blockedActions`[38;2;248;248;242m [38;2;255;255;255mor[0m
[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;230;219;116m`state.turn.completedActions`[38;2;248;248;242m.[0m
[38;2;248;248;242m [38;2;249;38;114m*/[0m
[38;2;102;217;239mfunction[38;2;248;248;242m [38;2;166;226;46mgetAvailableActions[38;2;248;248;242m([0m
[38;2;248;248;242m        [38;2;166;226;46mgame[38;2;248;248;242m: [38;2;255;255;255mGameModel[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;166;226;46mavailableEnergy[38;2;248;248;242m: [38;2;166;226;46mArray[38;2;249;38;114m<[38;2;255;255;255mTypeT[38;2;249;38;114m>[38;2;248;248;242m,[0m
[38;2;248;248;242m): [38;2;255;255;255mTurnActions[38;2;248;248;242m {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m {turn: [38;2;255;255;255mturnState[38;2;248;248;242m, [38;2;255;255;255mpickRequests[38;2;248;248;242m, [38;2;255;255;255mmodalRequests[38;2;248;248;242m} [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m {[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m} [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m {activeRowEntity: [38;2;255;255;255mactiveRowId[38;2;248;248;242m, singleUseCardUsed: [38;2;255;255;255msuUsed[38;2;248;248;242m} [38;2;249;38;114m=[0m
[38;2;248;248;242m                [38;2;255;255;255mcurrentPlayer[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mactions[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mTurnActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255msu[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;102;217;239mfind[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255msingleUse)[38;2;248;248;242m,[0m
[38;2;248;248;242m        ) [38;2;249;38;114mas[38;2;248;248;242m [38;2;166;226;46mCardComponent[38;2;248;248;242m<[38;2;166;226;46mSingleUse[38;2;248;248;242m> [38;2;249;38;114m|[38;2;248;248;242m [38;2;166;226;46mnull[0m

[38;2;248;248;242m        [38;2;117;113;94m// Custom modals[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(modalRequests[38;2;248;248;242m.length [38;2;249;38;114m>[38;2;248;248;242m [38;2;190;132;255m0[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mrequest[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mmodalRequests[38;2;248;248;242m[[38;2;190;132;255m0[38;2;248;248;242m][0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(request[38;2;248;248;242m.[38;2;255;255;255mplayer[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mreturn[38;2;248;248;242m [[38;2;230;219;116m'MODAL_REQUEST'[38;2;248;248;242m][0m
[38;2;248;248;242m                } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;117;113;94m// Activate opponent action timer[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;190;132;255mnull[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                        [38;2;249;38;114mreturn[38;2;248;248;242m [[38;2;230;219;116m'WAIT_FOR_OPPONENT_ACTION'[38;2;248;248;242m][0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// Pick requests[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(pickRequests[38;2;248;248;242m.length [38;2;249;38;114m>[38;2;248;248;242m [38;2;190;132;255m0[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mrequest[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mpickRequests[38;2;248;248;242m[[38;2;190;132;255m0[38;2;248;248;242m][0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(request[38;2;248;248;242m.[38;2;255;255;255mplayer[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mpickActions[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mTurnActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [[38;2;230;219;116m'PICK_REQUEST'[38;2;248;248;242m][0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(su[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255msuUsed)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mpickActions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'REMOVE_EFFECT'[38;2;255;255;255m)[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mpickActions[0m
[38;2;248;248;242m                } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;117;113;94m// Activate opponent action timer[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;190;132;255mnull[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                        [38;2;249;38;114mreturn[38;2;248;248;242m [[38;2;230;219;116m'WAIT_FOR_OPPONENT_ACTION'[38;2;248;248;242m][0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// There is no action currently active for the opponent, clear the time[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mnull[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mhasOtherHermit[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mexists[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m,[0m
[38;2;248;248;242m                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mhermit)[38;2;248;248;242m,[0m
[38;2;248;248;242m                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;166;226;46mnot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mactive))[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m

[38;2;248;248;242m        [38;2;117;113;94m// Actions that require us to have an active row[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(activeRowId[38;2;248;248;242m [38;2;249;38;114m!==[38;2;248;248;242m [38;2;190;132;255mnull[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;117;113;94m// Change active hermit[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(hasOtherHermit)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'CHANGE_ACTIVE_HERMIT'[38;2;255;255;255m)[0m
[38;2;248;248;242m                }[0m

[38;2;248;248;242m                [38;2;117;113;94m// Su actions[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(su[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255msuUsed)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'REMOVE_EFFECT'[38;2;255;255;255m)[0m
[38;2;248;248;242m                        [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'APPLY_EFFECT'[38;2;255;255;255m)[0m
[38;2;248;248;242m                }[0m

[38;2;248;248;242m                [38;2;117;113;94m// Attack actions[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(activeRowId[38;2;248;248;242m [38;2;249;38;114m!==[38;2;248;248;242m [38;2;190;132;255mnull[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;255;255;255mturnState[38;2;248;248;242m.[38;2;255;255;255mturnNumber[38;2;248;248;242m [38;2;249;38;114m>[38;2;248;248;242m [38;2;190;132;255m1[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mhermitCard[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;102;217;239mfind[38;2;255;255;255m([0m
[38;2;248;248;242m                                [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;166;226;46mrowIs[38;2;255;255;255m(activeRowId)[38;2;248;248;242m, [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mhermit)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        )[0m

[38;2;248;248;242m                        [38;2;117;113;94m// only add attack options if not sleeping[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(hermitCard[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;255;255;255mhermitCard[38;2;248;248;242m.[38;2;166;226;46misHermit[38;2;255;255;255m())[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;166;226;46mhasEnoughEnergy[38;2;255;255;255m([0m
[38;2;248;248;242m                                                [38;2;255;255;255mavailableEnergy[38;2;248;248;242m,[0m
[38;2;248;248;242m                                                [38;2;255;255;255mhermitCard[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255mprimary[38;2;248;248;242m.[38;2;255;255;255mcost[38;2;248;248;242m,[0m
[38;2;248;248;242m                                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mnoItemRequirements[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        )[0m
[38;2;248;248;242m                                ) {[0m
[38;2;248;248;242m                                        [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'PRIMARY_ATTACK'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;166;226;46mhasEnoughEnergy[38;2;255;255;255m([0m
[38;2;248;248;242m                                                [38;2;255;255;255mavailableEnergy[38;2;248;248;242m,[0m
[38;2;248;248;242m                                                [38;2;255;255;255mhermitCard[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255msecondary[38;2;248;248;242m.[38;2;255;255;255mcost[38;2;248;248;242m,[0m
[38;2;248;248;242m                                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mnoItemRequirements[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        )[0m
[38;2;248;248;242m                                ) {[0m
[38;2;248;248;242m                                        [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'SECONDARY_ATTACK'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(su[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255msuUsed)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(su[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;255;255;255msu[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255mhasAttack)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'SINGLE_USE_ATTACK'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                        }[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                }[0m

[38;2;248;248;242m                [38;2;117;113;94m// End turn action[0m
[38;2;248;248;242m                [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'END_TURN'[38;2;255;255;255m)[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// Play card actions require an active row unless it's the players first turn[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(activeRowId[38;2;248;248;242m [38;2;249;38;114m!==[38;2;248;248;242m [38;2;190;132;255mnull[38;2;248;248;242m [38;2;249;38;114m||[38;2;248;248;242m [38;2;255;255;255mturnState[38;2;248;248;242m.[38;2;255;255;255mturnNumber[38;2;248;248;242m [38;2;249;38;114m<=[38;2;248;248;242m [38;2;190;132;255m2[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;117;113;94m// Temporarily add these to see if any slots are available[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [[0m
[38;2;248;248;242m                        [38;2;249;38;114m...[38;2;255;255;255mactions[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;230;219;116m'PLAY_HERMIT_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;230;219;116m'PLAY_EFFECT_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;230;219;116m'PLAY_ITEM_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;230;219;116m'PLAY_SINGLE_USE_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                ][0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mdesiredActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components[0m
[38;2;248;248;242m                        .[38;2;166;226;46mfilter[38;2;255;255;255m([0m
[38;2;248;248;242m                                [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;166;226;46mplayer[38;2;255;255;255m(currentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mhand[38;2;248;248;242m,[0m
[38;2;248;248;242m                                ),[0m
[38;2;248;248;242m                        )[0m
[38;2;248;248;242m                        .[38;2;166;226;46mreduce[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mreducer[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mTurnActions[38;2;248;248;242m, [38;2;253;151;31mcard[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mCardComponent[38;2;248;248;242m)[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mTurnActions[38;2;248;248;242m [38;2;102;217;239m=>[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mpickableSlots[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mfilter[38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;255;255;255mSlotComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255mattachCondition[38;2;248;248;242m,[0m
[38;2;248;248;242m                                )[0m

[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(pickableSlots[38;2;248;248;242m.length [38;2;249;38;114m===[38;2;248;248;242m [38;2;190;132;255m0[38;2;255;255;255m)[38;2;248;248;242m [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mreducer[0m

[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;166;226;46misHealth[38;2;255;255;255m()[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([38;2;230;219;116m'PLAY_HERMIT_CARD'[38;2;255;255;255m))[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'PLAY_HERMIT_CARD'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;166;226;46misAttach[38;2;255;255;255m()[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([38;2;230;219;116m'PLAY_EFFECT_CARD'[38;2;255;255;255m))[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'PLAY_EFFECT_CARD'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;166;226;46misItem[38;2;255;255;255m()[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([38;2;230;219;116m'PLAY_ITEM_CARD'[38;2;255;255;255m))[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'PLAY_ITEM_CARD'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;166;226;46misSingleUse[38;2;255;255;255m()[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([38;2;230;219;116m'PLAY_SINGLE_USE_CARD'[38;2;255;255;255m))[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;255;255;255mreducer[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'PLAY_SINGLE_USE_CARD'[38;2;255;255;255m)[0m
[38;2;248;248;242m                                }[0m
[38;2;248;248;242m                                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mreducer[0m
[38;2;248;248;242m                        }, [] [38;2;249;38;114mas[38;2;248;248;242m [38;2;166;226;46mTurnActions[38;2;248;248;242m)[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m                [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;249;38;114m...[38;2;255;255;255mdesiredActions)[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// Filter out actions that have already been completed - once an action is completed it cannot be used again for the turn[0m
[38;2;248;248;242m        [38;2;117;113;94m// Also filter out blocked actions[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mblockedActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;166;226;46mgetAllBlockedActions[38;2;255;255;255m()[0m
[38;2;248;248;242m        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mfilteredActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mactions[38;2;248;248;242m.[38;2;166;226;46mfilter[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31maction[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                        [38;2;249;38;114m![38;2;255;255;255mturnState[38;2;248;248;242m.[38;2;255;255;255mcompletedActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m(action)[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                        [38;2;249;38;114m![38;2;255;255;255mblockedActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m(action)[0m
[38;2;248;248;242m                )[0m
[38;2;248;248;242m        })[0m

[38;2;248;248;242m        [38;2;117;113;94m// Force add change active hermit if the active row is null[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(activeRowId[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;190;132;255mnull[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;255;255;255mhasOtherHermit)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;255;255;255mfilteredActions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;230;219;116m'CHANGE_ACTIVE_HERMIT'[38;2;255;255;255m)[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mfilteredActions[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;248;248;242m [38;2;166;226;46mplayerAction[38;2;248;248;242m([38;2;253;151;31mactionType[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mstring[38;2;248;248;242m, [38;2;253;151;31mplayerEntity[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mPlayerEntity[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m ([38;2;253;151;31mactionAny[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46many[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255maction[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mactionAny[38;2;248;248;242m [38;2;249;38;114mas[38;2;248;248;242m [38;2;166;226;46mLocalMessage[0m
[38;2;248;248;242m                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                        [38;2;255;255;255maction[38;2;248;248;242m.type [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mlocalMessages[38;2;248;248;242m.[38;2;255;255;255mGAME_TURN_ACTION[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                        [38;2;230;219;116m'playerEntity'[38;2;248;248;242m [38;2;249;38;114min[38;2;248;248;242m [38;2;255;255;255maction[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                        [38;2;230;219;116m'action'[38;2;248;248;242m [38;2;249;38;114min[38;2;248;248;242m [38;2;255;255;255maction[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                        [38;2;255;255;255maction[38;2;248;248;242m.action.type [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mactionType[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                        [38;2;255;255;255maction[38;2;248;248;242m.[38;2;255;255;255mplayerEntity[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mplayerEntity[0m
[38;2;248;248;242m                )[0m
[38;2;248;248;242m        }[0m
[38;2;248;248;242m}[0m

[38;2;117;113;94m// return false in case one player is dead[0m
[38;2;117;113;94m// @TODO completely redo how we calculate if a hermit is dead etc[0m
[38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46mcheckHermitHealth[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mdeadPlayers[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mArray[38;2;248;248;242m<[38;2;166;226;46mPlayerComponent[38;2;248;248;242m> [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m        [38;2;249;38;114mfor[38;2;248;248;242m [38;2;255;255;255m([38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mplayerState[38;2;248;248;242m [38;2;249;38;114mof[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mfilter[38;2;255;255;255m(PlayerComponent))[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;117;113;94m// Players are not allowed to die before they place their first hermit to prevent bugs[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m![38;2;255;255;255mplayerState[38;2;248;248;242m.[38;2;255;255;255mhasPlacedHermit)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mcontinue[0m
[38;2;248;248;242m                }[0m

[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mhermitCards[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mfilter[38;2;255;255;255m([0m
[38;2;248;248;242m                        [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mattached[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mhermit)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mplayer[38;2;255;255;255m(playerState[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                )[0m

[38;2;248;248;242m                [38;2;249;38;114mfor[38;2;248;248;242m [38;2;255;255;255m([38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mcard[38;2;248;248;242m [38;2;249;38;114mof[38;2;248;248;242m [38;2;255;255;255mhermitCards)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m![38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m?.[38;2;166;226;46minRow[38;2;255;255;255m())[38;2;248;248;242m [38;2;249;38;114mcontinue[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m?.[38;2;255;255;255mrow[38;2;248;248;242m?.[38;2;255;255;255mhealth)[38;2;248;248;242m [38;2;249;38;114mcontinue[0m
[38;2;248;248;242m                        [38;2;117;113;94m// Add battle log entry. Non Hermit cards can create their detach message themselves.[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255mcategory[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;230;219;116m'hermit'[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mbattleLog[38;2;248;248;242m.[38;2;166;226;46maddDeathEntry[38;2;255;255;255m(playerState[38;2;248;248;242m.[38;2;255;255;255mentity[38;2;248;248;242m, [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mrow[38;2;248;248;242m.[38;2;255;255;255mentity)[0m
[38;2;248;248;242m                        }[0m

[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mrow[38;2;248;248;242m.[38;2;255;255;255mentity[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mplayerState[38;2;248;248;242m.[38;2;255;255;255mactiveRowEntity)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mplayerState[38;2;248;248;242m.[38;2;255;255;255mactiveRowEntity[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mnull[0m
[38;2;248;248;242m                        }[0m

[38;2;248;248;242m                        [38;2;117;113;94m// We wait to discard becuse you can not change from a row with no hermits to a new active row.[0m
[38;2;248;248;242m                        [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mrow[38;2;248;248;242m.[38;2;255;255;255mhealth[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mnull[0m
[38;2;248;248;242m                        [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mrow[38;2;248;248;242m.[38;2;166;226;46mgetAttach[38;2;255;255;255m()[38;2;248;248;242m?.[38;2;166;226;46mdiscard[38;2;255;255;255m()[0m
[38;2;248;248;242m                        [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mrow[38;2;248;248;242m.[38;2;166;226;46mgetItems[38;2;255;255;255m()[38;2;248;248;242m.[38;2;166;226;46mmap[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mitem[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mitem[38;2;248;248;242m.[38;2;166;226;46mdiscard[38;2;255;255;255m())[0m
[38;2;248;248;242m                        [38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mdiscard[38;2;255;255;255m()[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Only hermit cards give points[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(card[38;2;248;248;242m.[38;2;255;255;255mprops[38;2;248;248;242m.[38;2;255;255;255mcategory[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;230;219;116m'hermit'[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mplayerState[38;2;248;248;242m.[38;2;255;255;255mlives[38;2;248;248;242m [38;2;249;38;114m-=[38;2;248;248;242m [38;2;190;132;255m1[0m

[38;2;248;248;242m                                [38;2;117;113;94m// reward card[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mdisableRewardCards)[38;2;248;248;242m [38;2;249;38;114mcontinue[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.components[0m
[38;2;248;248;242m                                        .[38;2;166;226;46mfilter[38;2;255;255;255m([0m
[38;2;248;248;242m                                                [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                                                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mdeck)[38;2;248;248;242m,[0m
[38;2;248;248;242m                                                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mplayer[38;2;255;255;255m(playerState[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        )[0m
[38;2;248;248;242m                                        .[38;2;102;217;239msort[38;2;255;255;255m(CardComponent[38;2;248;248;242m.[38;2;255;255;255mcompareOrder)[0m
[38;2;248;248;242m                                        .[38;2;166;226;46mat[38;2;255;255;255m([38;2;190;132;255m0[38;2;255;255;255m)[0m
[38;2;248;248;242m                                        ?.[38;2;166;226;46mdraw[38;2;255;255;255m(playerState[38;2;248;248;242m.[38;2;255;255;255mopponentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                }[0m

[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255misDead[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mplayerState[38;2;248;248;242m.[38;2;255;255;255mlives[38;2;248;248;242m [38;2;249;38;114m<=[38;2;248;248;242m [38;2;190;132;255m0[0m

[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mnoHermitsLeft[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mexists[38;2;255;255;255m([0m
[38;2;248;248;242m                        [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mplayer[38;2;255;255;255m(playerState[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;255;255;255mattached[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mhermit)[38;2;248;248;242m,[0m
[38;2;248;248;242m                )[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(isDead[38;2;248;248;242m [38;2;249;38;114m||[38;2;248;248;242m [38;2;255;255;255mnoHermitsLeft)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255mdeadPlayers[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m(playerState)[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mdeadPlayers[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46msendGameState[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mviewers[38;2;248;248;242m.[38;2;102;217;239mforEach[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mviewer[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mlocalGameState[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mgetLocalGameState[38;2;255;255;255m(game[38;2;248;248;242m, [38;2;255;255;255mviewer)[0m

[38;2;248;248;242m                [38;2;166;226;46mbroadcast[38;2;255;255;255m([38;2;248;248;242m[[38;2;255;255;255mviewer[38;2;248;248;242m.[38;2;255;255;255mplayer[38;2;248;248;242m], {[0m
[38;2;248;248;242m                        [38;2;166;226;46mtype[38;2;248;248;242m: [38;2;255;255;255mserverMessages[38;2;248;248;242m.[38;2;255;255;255mGAME_STATE[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;255;255;255mlocalGameState[38;2;248;248;242m,[0m
[38;2;248;248;242m                })[0m
[38;2;248;248;242m        })[0m

[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mvoiceLineQueue[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46mturnActionSaga[38;2;248;248;242m([0m
[38;2;248;248;242m        [38;2;166;226;46mgame[38;2;248;248;242m: [38;2;255;255;255mGameModel[38;2;248;248;242m,[0m
[38;2;248;248;242m        [38;2;166;226;46mturnAction[38;2;248;248;242m: [38;2;255;255;255mLocalMessageTable[38;2;248;248;242m[[38;2;249;38;114mtypeof[38;2;248;248;242m [38;2;255;255;255mlocalMessages[38;2;248;248;242m.[38;2;255;255;255mGAME_TURN_ACTION[38;2;248;248;242m],[0m
[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mactionType[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mturnAction[38;2;248;248;242m.action.type[0m

[38;2;248;248;242m        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mendTurn[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mfalse[0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[0m
[38;2;248;248;242m                [38;2;255;255;255mturnAction[38;2;248;248;242m.[38;2;255;255;255mplayerEntity[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity[0m
[38;2;248;248;242m                        [38;2;249;38;114m?[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mavailableActions[0m
[38;2;248;248;242m                        : [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mopponentAvailableActions[0m

[38;2;248;248;242m        [38;2;249;38;114mtry[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;117;113;94m// We don't check if slot actions are available because the playCardSaga will verify that.[0m
[38;2;248;248;242m                [38;2;166;226;46massert[38;2;255;255;255m([0m
[38;2;248;248;242m                        [38;2;249;38;114m![38;2;248;248;242m[[0m
[38;2;248;248;242m                                [38;2;230;219;116m'SINGLE_USE_ATTACK'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PRIMARY_ATTACK'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'SECONDARY_ATTACK'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'CHANGE_ACTIVE_HERMIT'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'APPLY_EFFECT'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'REMOVE_EFFECT'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PICK_REQUEST'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'MODAL_REQUEST'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'END_TURN'[38;2;248;248;242m,[0m
[38;2;248;248;242m                        ].[38;2;166;226;46mincludes[38;2;255;255;255m(actionType)[38;2;248;248;242m [38;2;249;38;114m||[38;2;248;248;242m [38;2;255;255;255mavailableActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m(actionType)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        [38;2;230;219;116m'Players cannot be able to use a blocked action. This may be because the user does not have enough energy for the attack.'[38;2;248;248;242m,[0m
[38;2;248;248;242m                )[0m

[38;2;248;248;242m                [38;2;249;38;114mswitch[38;2;248;248;242m [38;2;255;255;255m(actionType)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'PLAY_HERMIT_CARD'[38;2;248;248;242m:[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'PLAY_ITEM_CARD'[38;2;248;248;242m:[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'PLAY_EFFECT_CARD'[38;2;248;248;242m:[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'PLAY_SINGLE_USE_CARD'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(playCardSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m.action[38;2;255;255;255m)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'SINGLE_USE_ATTACK'[38;2;248;248;242m:[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'PRIMARY_ATTACK'[38;2;248;248;242m:[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'SECONDARY_ATTACK'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(attackSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m.action[38;2;255;255;255m)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'CHANGE_ACTIVE_HERMIT'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(changeActiveHermitSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m.action[38;2;255;255;255m)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'APPLY_EFFECT'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(applyEffectSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m.action[38;2;255;255;255m)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'REMOVE_EFFECT'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(removeEffectSaga[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'PICK_REQUEST'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;255;255;255mpickRequestSaga[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        [38;2;255;255;255mgame[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        [38;2;255;255;255m(turnAction[38;2;248;248;242m.action [38;2;249;38;114mas[38;2;248;248;242m [38;2;166;226;46mPickSlotActionData[38;2;255;255;255m)[38;2;248;248;242m?.[38;2;255;255;255mentity[38;2;248;248;242m,[0m
[38;2;248;248;242m                                )[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'MODAL_REQUEST'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(modalRequestSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m?.action?.[38;2;255;255;255mmodalResult)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'END_TURN'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;255;255;255mendTurn[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mtrue[0m
[38;2;248;248;242m                                [38;2;117;113;94m// Turn end actions are not in the battle log, so we log them to stdout manually.[0m
[38;2;248;248;242m                                [38;2;166;226;46mconsole[38;2;248;248;242m.[38;2;102;217;239minfo[38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;230;219;116m`${[38;2;255;255;255mgame[38;2;230;219;116m.[38;2;255;255;255mlogHeader[38;2;230;219;116m} ${[38;2;255;255;255mgame[38;2;230;219;116m.[38;2;255;255;255mcurrentPlayer[38;2;230;219;116m.[38;2;255;255;255mplayerName[38;2;230;219;116m} ended their turn.`[38;2;248;248;242m,[0m
[38;2;248;248;242m                                )[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mcase[38;2;248;248;242m [38;2;230;219;116m'DELAY'[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(sendGameState[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(delaySaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m.action.[38;2;255;255;255mdelay)[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        [38;2;249;38;114mdefault[38;2;248;248;242m:[0m
[38;2;248;248;242m                                [38;2;117;113;94m// Unknown action type, ignore it completely[0m
[38;2;248;248;242m                                [38;2;249;38;114mthrow[38;2;248;248;242m [38;2;249;38;114mnew[38;2;248;248;242m [38;2;166;226;46mError[38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;230;219;116m`Recieved an action ${[38;2;255;255;255mactionType[38;2;230;219;116m} that does not exist. This is impossible.`[38;2;248;248;242m,[0m
[38;2;248;248;242m                                )[0m
[38;2;248;248;242m                                [38;2;249;38;114mreturn[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        } [38;2;249;38;114mcatch[38;2;248;248;242m [38;2;255;255;255m(e)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mlogErrorsToStderr)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;166;226;46mconsole[38;2;248;248;242m.[38;2;102;217;239merror[38;2;255;255;255m([38;2;230;219;116m`${[38;2;255;255;255mgame[38;2;230;219;116m.[38;2;255;255;255mlogHeader[38;2;230;219;116m} ${[38;2;255;255;255m(e[38;2;230;219;116m [38;2;249;38;114mas[38;2;230;219;116m [38;2;166;226;46mError[38;2;255;255;255m)[38;2;230;219;116m.[38;2;255;255;255mstack[38;2;230;219;116m}`[38;2;248;248;242m.[38;2;166;226;46mtrimStart[38;2;255;255;255m())[0m
[38;2;248;248;242m                } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mthrow[38;2;248;248;242m [38;2;255;255;255me[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// We log endTurn at the start of the turn so the state updates properly.[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mlogBoardState[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mendTurn)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;166;226;46mprintBoardState[38;2;255;255;255m(game)[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mdeadPlayers[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m        [38;2;255;255;255mdeadPlayers[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;249;38;114m...[38;2;255;255;255m([38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(checkDeckedOut[38;2;248;248;242m, [38;2;255;255;255mgame)))[0m
[38;2;248;248;242m        [38;2;255;255;255mdeadPlayers[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;249;38;114m...[38;2;255;255;255m([38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(checkHermitHealth[38;2;248;248;242m, [38;2;255;255;255mgame)))[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(deadPlayers[38;2;248;248;242m.length[38;2;255;255;255m)[38;2;248;248;242m [38;2;255;255;255mendTurn[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mtrue[0m

[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(endTurn)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'END_TURN'[0m
[38;2;248;248;242m        }[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;248;248;242m [38;2;166;226;46mgetPlayerAI[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mactivePlayerEntity[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mopponentAvailableActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;230;219;116m'WAIT_FOR_TURN'[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m
[38;2;248;248;242m                [38;2;249;38;114m?[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mcurrentPlayerEntity[0m
[38;2;248;248;242m                : [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mopponentPlayerEntity[0m

[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;102;217;239mfind[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;255;255;255mAIComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                ([38;2;253;151;31m_game[38;2;248;248;242m, [38;2;253;151;31mai[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mai[38;2;248;248;242m.[38;2;255;255;255mplayerEntity[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mactivePlayerEntity[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46mturnActionsSaga[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m {[38;2;255;255;255mopponentPlayer[38;2;248;248;242m, [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m} [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mturnActionChannel[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mactionChannel[38;2;255;255;255m([0m
[38;2;248;248;242m                [[0m
[38;2;248;248;242m                        [38;2;249;38;114m...[38;2;248;248;242m[[38;2;230;219;116m'PICK_REQUEST'[38;2;248;248;242m, [38;2;230;219;116m'MODAL_REQUEST'[38;2;248;248;242m].[38;2;166;226;46mmap[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mtype[38;2;248;248;242m) [38;2;102;217;239m=>[0m
[38;2;248;248;242m                                [38;2;166;226;46mplayerAction[38;2;255;255;255m(type[38;2;248;248;242m, [38;2;255;255;255mopponentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        ),[0m
[38;2;248;248;242m                        [38;2;249;38;114m...[38;2;248;248;242m[[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PLAY_HERMIT_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PLAY_ITEM_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PLAY_EFFECT_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PLAY_SINGLE_USE_CARD'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PICK_REQUEST'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'MODAL_REQUEST'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'CHANGE_ACTIVE_HERMIT'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'APPLY_EFFECT'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'REMOVE_EFFECT'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'SINGLE_USE_ATTACK'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'PRIMARY_ATTACK'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'SECONDARY_ATTACK'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'END_TURN'[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;230;219;116m'DELAY'[38;2;248;248;242m,[0m
[38;2;248;248;242m                        ].[38;2;166;226;46mmap[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mtype[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;166;226;46mplayerAction[38;2;255;255;255m(type[38;2;248;248;242m, [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity))[38;2;248;248;242m,[0m
[38;2;248;248;242m                ],[0m
[38;2;248;248;242m                [38;2;255;255;255mbuffers[38;2;248;248;242m.[38;2;166;226;46mdropping[38;2;255;255;255m([38;2;190;132;255m10[38;2;255;255;255m)[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m

[38;2;248;248;242m        [38;2;249;38;114mtry[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;249;38;114mwhile[38;2;248;248;242m [38;2;255;255;255m([38;2;190;132;255mtrue[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mshowHooksState[38;2;248;248;242m.[38;2;255;255;255menabled)[38;2;248;248;242m [38;2;166;226;46mprintHooksState[38;2;255;255;255m(game)[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Available actions code[0m
[38;2;248;248;242m                        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mavailableEnergy[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mgetAvailableEnergy[38;2;255;255;255m(game)[0m
[38;2;248;248;242m                        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mblockedActions[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mArray[38;2;248;248;242m<[38;2;166;226;46mTurnAction[38;2;248;248;242m> [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m                        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mgetAvailableActions[38;2;255;255;255m(game[38;2;248;248;242m, [38;2;255;255;255mavailableEnergy)[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Get blocked actions from hooks[0m
[38;2;248;248;242m                        [38;2;117;113;94m// @TODO this should also not really be a hook anymore[0m
[38;2;248;248;242m                        [38;2;117;113;94m// @TODO not only that but the blocked actions implementation needs improving, another card needs to be unable to remove another's block[0m
[38;2;248;248;242m                        [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mhooks[38;2;248;248;242m.[38;2;255;255;255mblockedActions[38;2;248;248;242m.[38;2;102;217;239mcall[38;2;255;255;255m(blockedActions)[0m

[38;2;248;248;242m                        [38;2;255;255;255mblockedActions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;249;38;114m...[38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mblockedActions)[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Remove blocked actions from the availableActions[0m
[38;2;248;248;242m                        [38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mavailableActions[38;2;248;248;242m.[38;2;166;226;46mfilter[38;2;255;255;255m([0m
[38;2;248;248;242m                                ([38;2;253;151;31maction[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;249;38;114m![38;2;255;255;255mblockedActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m(action)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        )[0m

[38;2;248;248;242m                        [38;2;255;255;255mavailableActions[38;2;248;248;242m.[38;2;102;217;239mpush[38;2;255;255;255m([38;2;249;38;114m...[38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mavailableActions)[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Set final actions in state[0m
[38;2;248;248;242m                        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mopponentAction[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mTurnAction[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'WAIT_FOR_TURN'[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mpickRequests[38;2;248;248;242m[[38;2;190;132;255m0[38;2;248;248;242m]?.[38;2;255;255;255mplayer[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mopponentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mopponentAction[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'PICK_REQUEST'[0m
[38;2;248;248;242m                        } [38;2;249;38;114melse[38;2;248;248;242m [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mmodalRequests[38;2;248;248;242m[[38;2;190;132;255m0[38;2;248;248;242m]?.[38;2;255;255;255mplayer[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mopponentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity[0m
[38;2;248;248;242m                        ) {[0m
[38;2;248;248;242m                                [38;2;255;255;255mopponentAction[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'MODAL_REQUEST'[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mopponentAvailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [[38;2;255;255;255mopponentAction[38;2;248;248;242m][0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mavailableActions[0m

[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mautoEndTurn[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                                [38;2;255;255;255mavailableActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([38;2;230;219;116m'END_TURN'[38;2;255;255;255m)[38;2;248;248;242m [38;2;249;38;114m&&[0m
[38;2;248;248;242m                                [38;2;255;255;255mavailableActions[38;2;248;248;242m.length [38;2;249;38;114m===[38;2;248;248;242m [38;2;190;132;255m1[0m
[38;2;248;248;242m                        ) {[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        }[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Timer calculation[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m=[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m||[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mmaxTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mmaxTurnTime[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;190;132;255m1000[0m
[38;2;248;248;242m                        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mremainingTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m+[38;2;248;248;242m [38;2;255;255;255mmaxTime[38;2;248;248;242m [38;2;249;38;114m-[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m

[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(availableActions[38;2;248;248;242m.[38;2;166;226;46mincludes[38;2;255;255;255m([38;2;230;219;116m'WAIT_FOR_OPPONENT_ACTION'[38;2;255;255;255m))[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m=[0m
[38;2;248;248;242m                                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m||[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                                [38;2;255;255;255mmaxTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mextraActionTime[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;190;132;255m1000[0m
[38;2;248;248;242m                                [38;2;255;255;255mremainingTime[38;2;248;248;242m [38;2;249;38;114m=[0m
[38;2;248;248;242m                                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mopponentActionStartTime[38;2;248;248;242m [38;2;249;38;114m+[38;2;248;248;242m [38;2;255;255;255mmaxTime[38;2;248;248;242m [38;2;249;38;114m-[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                        }[0m

[38;2;248;248;242m                        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mgraceTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255m1000[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnRemaining[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;102;217;239mMath[38;2;248;248;242m.[38;2;102;217;239mfloor[38;2;255;255;255m(remainingTime[38;2;248;248;242m [38;2;249;38;114m+[38;2;248;248;242m [38;2;255;255;255mgraceTime)[0m

[38;2;248;248;242m                        [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(sendGameState[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mbattleLog[38;2;248;248;242m.[38;2;166;226;46msendLogs[38;2;255;255;255m()[0m

[38;2;248;248;242m                        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mplayerAI[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mgetPlayerAI[38;2;255;255;255m(game)[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(playerAI)[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mfork[38;2;255;255;255m(virtualPlayerActionSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mplayerAI)[0m

[38;2;248;248;242m                        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mraceResult[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mrace[38;2;255;255;255m([38;2;248;248;242m{[0m
[38;2;248;248;242m                                [38;2;166;226;46mturnAction[38;2;248;248;242m: [38;2;166;226;46mtake[38;2;255;255;255m(turnActionChannel)[38;2;248;248;242m,[0m
[38;2;248;248;242m                                [38;2;166;226;46mtimeout[38;2;248;248;242m: [38;2;166;226;46mdelay[38;2;255;255;255m(remainingTime[38;2;248;248;242m [38;2;249;38;114m+[38;2;248;248;242m [38;2;255;255;255mgraceTime)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        }) [38;2;249;38;114mas[38;2;248;248;242m [38;2;166;226;46many[38;2;248;248;242m [38;2;117;113;94m// @NOTE - need to type as any due to typed-redux-saga inferring the wrong return type for action channel[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Reset coin flips[0m
[38;2;248;248;242m                        [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mcoinFlips[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m                        [38;2;255;255;255mopponentPlayer[38;2;248;248;242m.[38;2;255;255;255mcoinFlips[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m

[38;2;248;248;242m                        [38;2;117;113;94m// Handle timeout[0m
[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(raceResult[38;2;248;248;242m.[38;2;255;255;255mtimeout)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;117;113;94m// @TODO this works, but could be cleaned[0m
[38;2;248;248;242m                                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mcurrentAttack[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mcurrentAttack[0m
[38;2;248;248;242m                                [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mreset[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mfalse[0m

[38;2;248;248;242m                                [38;2;117;113;94m// First check to see if the opponent had a pick request active[0m
[38;2;248;248;242m                                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mcurrentPickRequest[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mpickRequests[38;2;248;248;242m[[38;2;190;132;255m0[38;2;248;248;242m][0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(currentPickRequest)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(currentPickRequest[38;2;248;248;242m.[38;2;255;255;255mplayer[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m!![38;2;255;255;255mcurrentAttack)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                        [38;2;255;255;255mreset[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mtrue[0m
[38;2;248;248;242m                                                }[0m
[38;2;248;248;242m                                        } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;255;255;255mreset[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mtrue[0m
[38;2;248;248;242m                                        }[0m
[38;2;248;248;242m                                }[0m

[38;2;248;248;242m                                [38;2;117;113;94m// Check to see if the opponent had a modal request active[0m
[38;2;248;248;242m                                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mcurrentModalRequest[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mmodalRequests[38;2;248;248;242m[[38;2;190;132;255m0[38;2;248;248;242m][0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(currentModalRequest)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(currentModalRequest[38;2;248;248;242m.[38;2;255;255;255mplayer[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m!![38;2;255;255;255mcurrentAttack)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                        [38;2;255;255;255mreset[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mtrue[0m
[38;2;248;248;242m                                                }[0m
[38;2;248;248;242m                                        } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;255;255;255mreset[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mtrue[0m
[38;2;248;248;242m                                        }[0m
[38;2;248;248;242m                                }[0m

[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(reset)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;117;113;94m// Timeout current request and remove it[0m
[38;2;248;248;242m                                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(currentPickRequest)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;166;226;46mremovePickRequest[38;2;255;255;255m()[0m
[38;2;248;248;242m                                        } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;166;226;46mremoveModalRequest[38;2;255;255;255m()[0m
[38;2;248;248;242m                                        }[0m

[38;2;248;248;242m                                        [38;2;117;113;94m// Reset timer to max time[0m
[38;2;248;248;242m                                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m                                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnRemaining[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mmaxTurnTime[0m

[38;2;248;248;242m                                        [38;2;117;113;94m// Execute attack now if there's a current attack[0m
[38;2;248;248;242m                                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m![38;2;255;255;255mgame[38;2;248;248;242m.[38;2;166;226;46mhasActiveRequests[38;2;255;255;255m()[38;2;248;248;242m [38;2;249;38;114m&&[38;2;248;248;242m [38;2;249;38;114m!![38;2;255;255;255mcurrentAttack)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                [38;2;117;113;94m// There are no active requests left, and we're in the middle of an attack. Execute it now.[0m
[38;2;248;248;242m                                                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mturnAction[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mAttackActionData[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m {[0m
[38;2;248;248;242m                                                        [38;2;166;226;46mtype[38;2;248;248;242m: [38;2;255;255;255mattackToAttackAction[38;2;248;248;242m[[38;2;255;255;255mcurrentAttack[38;2;248;248;242m],[0m
[38;2;248;248;242m                                                }[0m
[38;2;248;248;242m                                                [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(attackSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mturnAction[38;2;248;248;242m, [38;2;190;132;255mfalse[38;2;255;255;255m)[0m
[38;2;248;248;242m                                        }[0m

[38;2;248;248;242m                                        [38;2;249;38;114mcontinue[0m
[38;2;248;248;242m                                }[0m

[38;2;248;248;242m                                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mhasActiveHermit[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mexists[38;2;255;255;255m([0m
[38;2;248;248;242m                                        [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mplayer[38;2;255;255;255m(currentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                                        [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mactive[38;2;248;248;242m, [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255mhermit)[38;2;248;248;242m,[0m
[38;2;248;248;242m                                )[0m
[38;2;248;248;242m                                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(hasActiveHermit)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                        [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                                }[0m

[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mreason[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'time'[0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mdeadPlayerEntities[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity[38;2;248;248;242m][0m
[38;2;248;248;242m                                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[0m
[38;2;248;248;242m                        }[0m

[38;2;248;248;242m                        [38;2;117;113;94m// Run action logic[0m
[38;2;248;248;242m                        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mresult[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(turnActionSaga[38;2;248;248;242m, [38;2;255;255;255mgame[38;2;248;248;242m, [38;2;255;255;255mraceResult[38;2;248;248;242m.[38;2;255;255;255mturnAction)[0m

[38;2;248;248;242m                        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(result[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;230;219;116m'END_TURN'[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                                [38;2;249;38;114mbreak[0m
[38;2;248;248;242m                        }[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        } [38;2;249;38;114mfinally[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;255;255;255mturnActionChannel[38;2;248;248;242m.[38;2;102;217;239mclose[38;2;255;255;255m()[0m
[38;2;248;248;242m        }[0m
[38;2;248;248;242m}[0m

[38;2;249;38;114mexport[38;2;248;248;242m [38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46mturnSaga[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m {[38;2;255;255;255mcurrentPlayer[38;2;248;248;242m, [38;2;255;255;255mopponentPlayer[38;2;248;248;242m} [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[0m

[38;2;248;248;242m        [38;2;117;113;94m// Reset turn state[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mavailableActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mcompletedActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mblockedActions[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m {}[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mcurrentAttack[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mnull[0m
[38;2;248;248;242m        [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255msingleUseCardUsed[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mfalse[0m
[38;2;248;248;242m        [38;2;255;255;255mopponentPlayer[38;2;248;248;242m.[38;2;255;255;255msingleUseCardUsed[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255mfalse[0m

[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnStartTime[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;166;226;46mDate[38;2;248;248;242m.[38;2;166;226;46mnow[38;2;255;255;255m()[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mtimer[38;2;248;248;242m.[38;2;255;255;255mturnRemaining[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mmaxTurnTime[38;2;248;248;242m [38;2;249;38;114m*[38;2;248;248;242m [38;2;190;132;255m1000[0m

[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mbattleLog[38;2;248;248;242m.[38;2;166;226;46maddTurnStartEntry[38;2;255;255;255m()[0m

[38;2;248;248;242m        [38;2;117;113;94m// Call turn start hooks[0m
[38;2;248;248;242m        [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mhooks[38;2;248;248;242m.[38;2;255;255;255monTurnStart[38;2;248;248;242m.[38;2;102;217;239mcall[38;2;255;255;255m()[0m

[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mlogBoardState)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;166;226;46mprintBoardState[38;2;255;255;255m(game)[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// Check for dead hermits on turn start[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(game[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mturnNumber[38;2;248;248;242m [38;2;249;38;114m>[38;2;248;248;242m [38;2;190;132;255m2[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mturnStartDeadPlayers[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(checkHermitHealth[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(turnStartDeadPlayers[38;2;248;248;242m.length[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mreason[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mturnStartDeadPlayers[38;2;248;248;242m.[38;2;166;226;46mevery[38;2;255;255;255m([0m
[38;2;248;248;242m                                ([38;2;253;151;31mdeadPlayer[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mdeadPlayer[38;2;248;248;242m.[38;2;255;255;255mlives[38;2;248;248;242m [38;2;249;38;114m<=[38;2;248;248;242m [38;2;190;132;255m0[38;2;248;248;242m,[0m
[38;2;248;248;242m                        )[0m
[38;2;248;248;242m                                [38;2;249;38;114m?[38;2;248;248;242m [38;2;230;219;116m'lives'[0m
[38;2;248;248;242m                                : [38;2;230;219;116m'hermits'[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mdeadPlayerEntities[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mturnStartDeadPlayers[38;2;248;248;242m.[38;2;166;226;46mmap[38;2;255;255;255m([0m
[38;2;248;248;242m                                ([38;2;253;151;31mplayer[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mplayer[38;2;248;248;242m.[38;2;255;255;255mentity[38;2;248;248;242m,[0m
[38;2;248;248;242m                        )[0m
[38;2;248;248;242m                        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mresult[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(turnActionsSaga[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(result[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[38;2;255;255;255m)[38;2;248;248;242m [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[0m

[38;2;248;248;242m        [38;2;117;113;94m// Draw a card from deck when turn ends[0m
[38;2;248;248;242m        [38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mdrawCards[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;166;226;46mdraw[38;2;255;255;255m([38;2;190;132;255m1[38;2;255;255;255m)[0m

[38;2;248;248;242m        [38;2;117;113;94m// Call turn end hooks[0m
[38;2;248;248;242m        [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mhooks[38;2;248;248;242m.[38;2;255;255;255monTurnEnd[38;2;248;248;242m.[38;2;102;217;239mcall[38;2;255;255;255m(drawCards)[0m

[38;2;248;248;242m        [38;2;117;113;94m// Timeout and clear pick requests[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mpickRequests[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mpickRequests[0m
[38;2;248;248;242m        [38;2;249;38;114mfor[38;2;248;248;242m [38;2;255;255;255m([38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mi[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255m0[38;2;248;248;242m; [38;2;255;255;255mi[38;2;248;248;242m [38;2;249;38;114m<[38;2;248;248;242m [38;2;255;255;255mpickRequests[38;2;248;248;242m.length; [38;2;255;255;255mi[38;2;249;38;114m++[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;255;255;255mpickRequests[38;2;248;248;242m[[38;2;255;255;255mi[38;2;248;248;242m].[38;2;166;226;46monTimeout[38;2;248;248;242m?.[38;2;255;255;255m()[0m
[38;2;248;248;242m        }[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mpickRequests[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m

[38;2;248;248;242m        [38;2;117;113;94m// Timeout and clear modal requests[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mmodalRequests[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mmodalRequests[0m
[38;2;248;248;242m        [38;2;249;38;114mfor[38;2;248;248;242m [38;2;255;255;255m([38;2;102;217;239mlet[38;2;248;248;242m [38;2;255;255;255mi[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;190;132;255m0[38;2;248;248;242m; [38;2;255;255;255mi[38;2;248;248;242m [38;2;249;38;114m<[38;2;248;248;242m [38;2;255;255;255mmodalRequests[38;2;248;248;242m.length; [38;2;255;255;255mi[38;2;249;38;114m++[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;255;255;255mmodalRequests[38;2;248;248;242m[[38;2;255;255;255mi[38;2;248;248;242m].[38;2;166;226;46monTimeout[38;2;255;255;255m()[0m
[38;2;248;248;242m        }[0m
[38;2;248;248;242m        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mmodalRequests[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [][0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mdeadPlayers[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mPlayerComponent[38;2;248;248;242m[] [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(checkHermitHealth[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(deadPlayers[38;2;248;248;242m.length[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(deadPlayers[38;2;248;248;242m.[38;2;166;226;46mevery[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mplayer[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mplayer[38;2;248;248;242m.[38;2;255;255;255mlives[38;2;248;248;242m [38;2;249;38;114m<=[38;2;248;248;242m [38;2;190;132;255m0[38;2;255;255;255m))[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mreason[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'lives'[0m
[38;2;248;248;242m                } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mreason[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'hermits'[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mdeadPlayerEntities[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mdeadPlayers[38;2;248;248;242m.[38;2;166;226;46mmap[38;2;255;255;255m([38;2;248;248;242m([38;2;253;151;31mplayer[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mplayer[38;2;248;248;242m.[38;2;255;255;255mentity)[0m
[38;2;248;248;242m                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mdeckedOutPlayers[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mPlayerEntity[38;2;248;248;242m[] [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(checkDeckedOut[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(deckedOutPlayers[38;2;248;248;242m.length[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mreason[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;230;219;116m'cards'[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mendInfo[38;2;248;248;242m.[38;2;255;255;255mdeadPlayerEntities[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mdeckedOutPlayers[0m
[38;2;248;248;242m                [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;117;113;94m// If player has not used his single use card return it to hand[0m
[38;2;248;248;242m        [38;2;117;113;94m// otherwise move it to discarded pile[0m
[38;2;248;248;242m        [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255msingleUseCard[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;102;217;239mfind[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;255;255;255mCardComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                [38;2;255;255;255mquery[38;2;248;248;242m.[38;2;255;255;255mcard[38;2;248;248;242m.[38;2;166;226;46mslot[38;2;255;255;255m(query[38;2;248;248;242m.[38;2;255;255;255mslot[38;2;248;248;242m.[38;2;255;255;255msingleUse)[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(singleUseCard)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([38;2;249;38;114m![38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255msingleUseCardUsed)[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255msingleUseCard[38;2;248;248;242m.[38;2;166;226;46mattach[38;2;255;255;255m([0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mnew[38;2;255;255;255m(HandSlotComponent[38;2;248;248;242m, [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        )[0m
[38;2;248;248;242m                } [38;2;249;38;114melse[38;2;248;248;242m {[0m
[38;2;248;248;242m                        [38;2;255;255;255msingleUseCard[38;2;248;248;242m.[38;2;166;226;46mattach[38;2;255;255;255m([0m
[38;2;248;248;242m                                [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mnew[38;2;255;255;255m(DiscardSlotComponent[38;2;248;248;242m, [38;2;255;255;255mcurrentPlayer[38;2;248;248;242m.[38;2;255;255;255mentity)[38;2;248;248;242m,[0m
[38;2;248;248;242m                        )[0m
[38;2;248;248;242m                }[0m
[38;2;248;248;242m        }[0m

[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;230;219;116m'DONE'[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46mcheckDeckedOut[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mdisableDeckOut[38;2;248;248;242m [38;2;249;38;114m||[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255mstartWithAllCards[38;2;248;248;242m [38;2;249;38;114m||[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255msettings[38;2;248;248;242m.[38;2;255;255;255munlimitedCards[0m
[38;2;248;248;242m        )[0m
[38;2;248;248;242m                [38;2;249;38;114mreturn[38;2;248;248;242m [][0m
[38;2;248;248;242m        [38;2;249;38;114mreturn[38;2;248;248;242m [38;2;255;255;255mgame[38;2;248;248;242m.components.[38;2;166;226;46mfilterEntities[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;255;255;255mPlayerComponent[38;2;248;248;242m,[0m
[38;2;248;248;242m                ([38;2;253;151;31m_game[38;2;248;248;242m, [38;2;253;151;31mplayer[38;2;248;248;242m) [38;2;102;217;239m=>[38;2;248;248;242m [38;2;255;255;255mplayer[38;2;248;248;242m.[38;2;255;255;255mdeckedOut[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m
[38;2;248;248;242m}[0m

[38;2;102;217;239mfunction[38;2;249;38;114m*[38;2;248;248;242m [38;2;166;226;46mgameSaga[38;2;248;248;242m([38;2;253;151;31mgame[38;2;249;38;114m:[38;2;248;248;242m [38;2;166;226;46mGameModel[38;2;248;248;242m) {[0m
[38;2;248;248;242m        [38;2;166;226;46mconsole[38;2;248;248;242m.[38;2;102;217;239minfo[38;2;255;255;255m([0m
[38;2;248;248;242m                [38;2;230;219;116m`${[38;2;255;255;255mgame[38;2;230;219;116m.[38;2;255;255;255mlogHeader[38;2;230;219;116m} ${[38;2;255;255;255mgame[38;2;230;219;116m.[38;2;255;255;255mopponentPlayer[38;2;230;219;116m.[38;2;255;255;255mplayerName[38;2;230;219;116m} was decided to be the first player.`[38;2;248;248;242m,[0m
[38;2;248;248;242m        )[0m
[38;2;248;248;242m        [38;2;249;38;114mwhile[38;2;248;248;242m [38;2;255;255;255m([38;2;190;132;255mtrue[38;2;255;255;255m)[38;2;248;248;242m {[0m
[38;2;248;248;242m                [38;2;255;255;255mgame[38;2;248;248;242m.[38;2;255;255;255mstate[38;2;248;248;242m.[38;2;255;255;255mturn[38;2;248;248;242m.[38;2;255;255;255mturnNumber[38;2;249;38;114m++[0m
[38;2;248;248;242m                [38;2;102;217;239mconst[38;2;248;248;242m [38;2;255;255;255mresult[38;2;248;248;242m [38;2;249;38;114m=[38;2;248;248;242m [38;2;249;38;114myield*[38;2;248;248;242m [38;2;166;226;46mcall[38;2;255;255;255m(turnSaga[38;2;248;248;242m, [38;2;255;255;255mgame)[0m
[38;2;248;248;242m                [38;2;249;38;114mif[38;2;248;248;242m [38;2;255;255;255m(result[38;2;248;248;242m [38;2;249;38;114m===[38;2;248;248;242m [38;2;230;219;116m'GAME_END'[38;2;255;255;255m)[38;2;248;248;242m [38;2;249;38;114mbreak[0m
[38;2;248;248;242m        }[0m
[38;2;248;248;242m}[0m

[38;2;249;38;114mexport[38;2;248;248;242m [38;2;249;38;114mdefault[38;2;248;248;242m [38;2;255;255;255mgameSaga[0m
